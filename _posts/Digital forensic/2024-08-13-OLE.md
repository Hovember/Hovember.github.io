---
layout: single
title: "[Digital Forenisc] - OLE 파일 구조"
excerpt: "OLE 파일 구조"
categories:
  - Forensic
date: 2024-08-20
last_modified_at: 2024-08-20
---

점프리스트 파일이 OLE 파일 구조로 되어 있다고 해서 OLE 파일의 구조를 분석해보았다. 헷갈리는 부분이 많아서 생각보다 어려웠지만, 실습을 통해 분석하니 이해하는데 도움이 됐고 무엇보다 분석은 재밌다. 

# OLE 파일

OLE (Object Linking and Embedding) 객체 연결 삽입<br>

OLE 파일 포맷의 내부는 하나의 작은 파일 시스템 같은 구조를 가져 폴더(스토리지) 및 파일(스트림)의 개념이 있다. 또한, OLE 파일은 상/하위 버전에 대한 높은 호환성을 가지고 있다. (높은 버전의 워드로 문서를 작성해도 낮은 버전에서 해당 문서를 읽을 수 있다)

워드 엑셀 등의 MS Office, 이외에 다른 워드 프로세서들도 OLE 파일 형식 사용<BR>
(이제는 xml 파일 형식을 사용하는 거 같다. docx hwpx 등)

# OLE 파일 구조

<table><thead>
  <tr>
    <td>Header<br>(512 Bytes)</td>
    <td>Data<br>(파일 크기 - Header)</td>
  </tr></thead>
</table>

OLE 파일은 512바이트(1섹터)씩 나눠져 있어 헤더 영역 512 Bytes, 데이터 영역은 파일 크기에서 헤더 영역을 제외한 나머지 영역이다.

헤더 영역에는 파일 시그니처, Start of Directory sector등 OLE 파일 전체의 주요 정보가 저장된다.

데이터 영역에는 스트림과 스토리지 정보, BBAT, SBAT, 스트림 데이터가 저장된다.<br> 
*데이터 영역 대부분은 스트림 데이터가 차지하고 있다. 

섹터 순서는 헤더 영역과 따로 데이터 영역 따로 나눠져 있다고 생각하면 편하다.

헤더 영역이 0번 섹터라면 데이터 영역에 첫 번째 섹터도 0번 섹터이다. 따라서, 섹터 번호가 주어지고 오프셋을 계산할 때 512Bytes(0x200)를 추가로 더해야 한다.

## Header (512Bytes)

|     Name                                             |     Offset   (d)    |     Size   (Byte)    |     Value                                                                                         |
|------------------------------------------------------|---------------------|----------------------|---------------------------------------------------------------------------------------------------|
|     File Signature                                   |     0 – 7           |     8                |     0xD0 CF   11 E0 A1 B1 1A E1                                                                   |
|     CLSID                                            |     8 – 23          |     16               |     0x00~00                                                                                       |
|     Minor   Version                                  |     24 – 25         |     2                |     0x3E 00                                                                                       |
|     Major   Version                                  |     26 – 27         |     2                |     0x03 00                                                                                       |
|     Byte   Order                                     |     28 – 29         |     2                |     0xFE FF –   리틀엔디안     0xFF FE -   빅엔디안                                               |
|     Sector   Size (BBAT)                             |     30 – 31         |     2                |     0x09 00 /   1섹터 크기 =   2^9=512                                                            |
|     Small   Sector Size (SBAT)                       |     32 – 33         |     2                |     0x06 00 /   SBAT 섹터 1개   크기 = 2^6                                                        |
|     Reserved 1, 2, 3                                 |     34 – 43         |     10               |     X                                                                                             |
|     Number of   BBAT Depot                           |     44 – 47         |     4                |     BBAT   Depot 개수,      109개 이상일 경우 Extra BBAT 참조                                     |
|     Start of Directory Sector                        |     48 – 51         |     4                |     스트림과 스토리지의 정보를 담고 있는   영역 섹터 시작 번호                                    |
|     Reserved 4                                       |     52 – 55         |     4                |     X                                                                                             |
|     Small   Stream Cutoff                            |     56 – 59         |     4                |     0x00 10   00 00 / 0x1000 = 4096 Bytes / 이   사이즈 미만인 스트림을 읽을 때는 SBAT를 참조     |
|     Start of   SBAT Sector                           |     60 – 63         |     4                |     SBAT 섹터 시작 번호                                                                           |
|     Number of   SBAT Depot                           |     64 – 67         |     4                |     SBAT   Depot 개수                                                                             |
|     Start   Block of Extra Block Allocation Table    |     68 – 71         |     4                |     0xFE FF   FF FF      (BBAT   Depot가 109개   이하인 경우)                                     |
|     Number of   Extra Big Block Allocation Table     |     72 – 75         |     4                |     0x00 00   00 00      (BBAT   Depot가 109개   이하인 경우, 111개의 경우 0x02)                  |
|     BBAT   Depot                                     |     76 ~            |     436              |     헤더 끝까지 4바이트씩 109개의 BBAT Depot들이   저장된다.     *109개 이상일 경우 Extra 참조    |

# Reference💻

1: [https://www.hanul93.com/search/?tags=OLE](https://www.hanul93.com/search/?tags=OLE)

2: [https://nurilab.github.io/2020/05/04/fileformat_ole_1/](https://nurilab.github.io/2020/05/04/fileformat_ole_1/)
