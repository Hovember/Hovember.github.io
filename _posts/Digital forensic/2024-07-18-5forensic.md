---
layout: single
title: "[Digital Forenisc] - FAT32"
excerpt: "FAT32 분석"
categories:
  - Forensic
date: 2024-07-18
last_modified_at: 2024-07-18
---

# FAT32 구조 

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-6o2b{background-color:#ffccc9;border-color:#333333;color:#000000;text-align:center;vertical-align:top}
.tg .tg-sy1x{background-color:#9aff99;border-color:#333333;color:#000000;text-align:center;vertical-align:top}
.tg .tg-hl7l{background-color:#96fffb;border-color:#333333;color:#000000;text-align:center;vertical-align:top}
</style>
<table class="tg"><thead>
  <tr>
    <td class="tg-sy1x">Reserved Area</td>
    <td class="tg-hl7l">FAT Area</td>
    <td class="tg-6o2b">Data Area</td>
  </tr></thead>
</table>

<br>

## Reserved Area (32 Sector)

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-xgk9{background-color:#9aff99;border-color:#333333;color:#000000;text-align:center;vertical-align:top}
</style>
<table class="tg"><thead>
  <tr>
    <td class="tg-xgk9">Boot Sector</td>
    <td class="tg-xgk9">FSINFO</td>
    <td class="tg-xgk9">Boot Strap</td>
    <td class="tg-xgk9">More Space</td>
  </tr></thead>
</table>

### Boot Sector (512Bytes)

Boot Sector는 FAT 파일시스템 가장 첫 번째 섹터에 위치

부트섹터의 첫 36 Bytes는 FAT12/16, FAT32 다 같다. 

**0~2 Bytes 부트 코드로 점프하라는 명령어**

- 운영체제가 부팅하는데 필요한 코드를 찾을 수 있도록 컴퓨터에 알려주는 어셈블리 명령어

- 기본값 0xEB 58 90

**3~89 Bytes BIOS Parameter Block(BPB)**

 - 중요 정보가 포함되어 있다.

<style type="text/css">
.tg  {border-collapse:collapse;border-color:#93a1a1;border-spacing:0;}
.tg td{background-color:#fdf6e3;border-color:#93a1a1;border-style:solid;border-width:1px;color:#002b36;
  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{background-color:#657b83;border-color:#93a1a1;border-style:solid;border-width:1px;color:#fdf6e3;
  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-iiht{background-color:#FDF6E3;border-color:#000000;color:#002B36;text-align:center;vertical-align:top}
.tg .tg-chz4{background-color:#657B83;border-color:#000000;color:#FDF6E3;text-align:center;vertical-align:top}
.tg .tg-djsi{background-color:#FDF6E3;border-color:#000000;color:#002B36;text-align:center;vertical-align:top}
</style>
<table class="tg"><thead>
  <tr>
    <th class="tg-chz4">00</th>
    <th class="tg-chz4">01</th>
    <th class="tg-chz4">02</th>
    <th class="tg-chz4">03</th>
    <th class="tg-chz4">04</th>
    <th class="tg-chz4">05</th>
    <th class="tg-chz4">06</th>
    <th class="tg-chz4">07</th>
    <th class="tg-chz4">08</th>
    <th class="tg-chz4">09</th>
    <th class="tg-chz4">10</th>
    <th class="tg-chz4">11</th>
    <th class="tg-chz4">12</th>
    <th class="tg-chz4">13</th>
    <th class="tg-chz4">14</th>
    <th class="tg-chz4">15</th>
  </tr></thead>
<tbody>
  <tr>
    <td class="tg-iiht" colspan="3">Jump Boot Code</td>
    <td class="tg-iiht" colspan="8">OEM 이름(ASCII)</td>
    <td class="tg-iiht" colspan="2">Bytes per Sector</td>
    <td class="tg-iiht">Sec per Clus</td>
    <td class="tg-iiht" colspan="2">Reserved Sector count</td>
  </tr>
  <tr>
    <td class="tg-djsi">Num FTAS</td>
    <td class="tg-djsi" colspan="2">Root Entry count</td>
    <td class="tg-djsi" colspan="2">Total Sector 16</td>
    <td class="tg-djsi">Media Type</td>
    <td class="tg-djsi" colspan="2">FAT Size 16</td>
    <td class="tg-djsi" colspan="2">Sector Per Track</td>
    <td class="tg-djsi" colspan="2">Num of Heads</td>
    <td class="tg-djsi" colspan="4">Hidden Sector</td>
  </tr>
  <tr>
    <td class="tg-iiht" colspan="4">Total Sector 32</td>
    <td class="tg-iiht" colspan="4">FAT Size 32</td>
    <td class="tg-iiht" colspan="2">Ext Flags</td>
    <td class="tg-iiht" colspan="2">File Sys Version</td>
    <td class="tg-iiht" colspan="4">Root Directory Cluster</td>
  </tr>
  <tr>
    <td class="tg-djsi" colspan="2">File Sys Info</td>
    <td class="tg-djsi" colspan="2">Backup Boot Sec</td>
    <td class="tg-djsi" colspan="12">Reserved</td>
  </tr>
  <tr>
    <td class="tg-iiht">Drive Number</td>
    <td class="tg-iiht">Reserv1</td>
    <td class="tg-iiht">Boot signature</td>
    <td class="tg-iiht" colspan="4">Volume ID</td>
    <td class="tg-iiht" colspan="9">Volume Label</td>
  </tr>
  <tr>
    <td class="tg-djsi" colspan="2">Volume Label</td>
    <td class="tg-djsi" colspan="8">File System Type</td>
    <td class="tg-djsi" colspan="6"></td>
  </tr>
</tbody></table>

- 3~10 Bytes ***OEM ID*** 운영체제 버전별 생성되는 OEM 표시 이름 
  - Linux - mkdosfs
  - Windows 2000/XP/Vista - MSDOS 5.0

- 11~12 Bytes ***Bytes per Sector*** 한 섹터 당 바이트 수 
  - 0x00 02 (512)

- 13 Bytes ***Sector per Cluster*** 한 클러스터가 가지는 섹터의 수 (최대 클러스터 크기 = 32KB)
  - 0x10 (16)

- 14~15 Bytes ***Reserved Sector Count*** 예약된 영역의 섹터 크기, FAT32는 32개 섹터 사용 
  - 0x90 0D (3472)

- 16 Bytes ***Number of FAT Tables*** FAT 영역의 개수, 백업까지 2개 사용
  - 0x02 (2)  

- 17~18 Bytes ***Root Directory Entry Count*** 루트 디렉터리에 있을 수 있는 최대 파일 개수,
  - FAT12/16에만 해당하며 일반적으로 512 저장 FAT32는 0 

- 19~20 Bytes ***Total Sector 16*** 파일시스템에 있는 총 섹터 수, 2바이트로 표현, 공간이 부족하면 Total Sector 32 사용

- 21 Bytes ***Media Type*** 미디어 유형, 0xF8은 고정된 매체
  - 0xF0/F9/FD/FF/FC/FE 등은 이동식 매체

- 22~23 Bytes ***FAT Size 16*** FAT12/16의 FAT 영역의 섹터 수, FAT 32는 0 

- 24~25 Bytes ***Sectors Per Track*** 저장 장치의 트랙 당 섹터 수, 보통
  - 0x3F 00 (63)

- 26~27 Bytes ***Number of Heads*** 장치의 헤더 수 
  - 0xFF 00 (255)

- 28~31 Bytes ***Hidden Sectors*** 파티션 시작 전 섹터 수 
  - 0x00 08 00 00 (2048)

- 32~35 Bytes ***Total Sector32*** 파일시스템에 있는 총 섹터의 수, 4 바이트로 표현, 
  - Total Sector 16값과 둘 중 하나는 반드시 0, 0x00 38 CA 01 (30029824)

**여기부터 FAT32에 해당**

- 36~39 Bytes ***FAT Size 32(Sector per FAT)*** FAT 하나의 영역이 가지는 섹터 수 
  - 0x38 39 00 00 (14648)

- 40~41 Bytes ***Extended Flags*** 여러 개의 FAT 영역을 사용할 경우 설정값을 표시하는 것으로 비트로 표현했을 때 7번째 비트가 1이면 FAT 구조체 중 1개만 활성화되며 활성화할 FAT 번호는 비트 0~3의 위치에 표시 

- 42~43 Bytes ***File System Version*** 파일시스템의 주 버전과 하위 버전 번호 

- 44~47 Bytes ***Root Directory Cluster*** 루트 디렉터리가 있는 클러스터 위치로 FAT32는 FAT12/16과 다르게 가변적, 따라서 위치값을 보고 찾아갈 수 있지만, 일반적으로 클러스터 2번 사용 
  - 0x02 00 00 00 (2)

- 48~49 Bytes ***File System Information*** FSINFO 구조체가 있는 섹터 위치, 보통 0x01 00 

- <span style="text-decoration: underline; text-decoration-color: red; text-decoration-style: wavy">50~51 Bytes ***Backup Boot Record*** 부트섹터 복사본이 있는 섹터 위치 보통 0x06 00 (0x00 06)</span>

- 52~63 Bytes ***Reserved*** 예약된 공간 

- 64 Bytes ***Drive Number*** BIOS INT13h 드라이브 번호 0x80

- ~~65 Bytes Reserv1 사용하지 않음~~ 

- 66 Bytes ***Boot Signature*** 확장 부트 시그니처, 존재할 경우 Volume ID, Label, File System Type이 유효하다는 의미, 보통 0x29

- 67~70 Bytes ***Volume ID*** 볼륨 시리얼 번호 0xEA CB 4D 92

- 71~81 Bytes ***Volume Label*** 볼륨 레이블, 값이 없으면 NO NAME으로 표시

- 82~89 Bytes ***File System Type*** 파일시스템 형식 표시, 일반적으로 FAT32 표시

- **90~ 509 Bytes 부트 코드와 오류 메시지 저장**

- **510 ~ 511 Bytes 시그니처 (55 AA)**

![ ](/assets/forensic/fat32.png "Boot Sector")

### FSINFO 

Boot Sector 바로 다음 섹터에 위치<br>
운영체제가 새로운 클러스터를 어디에 할당할지 설명하는 구조체<br>
즉, 저장할 데이터를 빠르게 할당할 수 있도록 알려주는 구조체

![ ](/assets/forensic/fsinfo.png "Boot Sector")

0~3 시그니처 0x41 61 52 52 

484~487 시그니처 0x61 41 72 72

488~491 비할당 클러스터 수(Num of Free Clusters)<br>
0x00 1A 72 57 (1733207)

492~495 첫(다음) 비할당 클러스터(Next Free Clusters)<br>
0x00 00 6C 32 (27698)

508~511 시그니처 (0x55 AA)

## FAT Area

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-487o{background-color:#96fffb;border-color:#000000;text-align:center;vertical-align:top}
</style>
<table class="tg"><thead>
  <tr>
    <td class="tg-487o">FAT #1</td>
    <td class="tg-487o">FAT #2</td>
  </tr></thead>
</table>

- 파일 시스템에서 가장 중요한 역할을 담당<br>
- 클러스터의 할당 상태를 판단하고 파일이나 디렉터리 다음에 할당할 클러스터를 찾는데 사용<br>
- 두 개의 FAT은 서로 백업 관계로 동일하다.<br>
- 같은 크기의 엔트리(32bit)들로 구성된다.<br> 
  - FAT16은 16bit 엔트리, FAT12는 12bit 엔트리로 구성<br>
- 각각의 엔트리는 같은 주소의 클러스터와 매칭되는데 <br>
  - 만약 클러스터가 할당되어 있지 않으면 엔트리의 값은 0이다.<br>
  - 만약 클러스터가 할당되면 그 엔트리에는 파일이나 디렉터리의 다음 클러스터 주소가 포함 

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-c3ow{border-color:inherit;text-align:center;vertical-align:top}
</style>
<table class="tg"><thead>
  <tr>
    <th class="tg-c3ow">0x0000 0000</th>
    <th class="tg-c3ow">미할당 상태로 사용 가능하다.</th>
  </tr></thead>
<tbody>
  <tr>
    <td class="tg-c3ow">0x?000 0001</td>
    <td class="tg-c3ow">예약된 클러스터</td>
  </tr>
  <tr>
    <td class="tg-c3ow">0x?000 0002 ~ 0x?FFF FFEF</td>
    <td class="tg-c3ow">할당된 클러스터</td>
  </tr>
  <tr>
    <td class="tg-c3ow">0x?FFF FFF0 ~   0x?FFF FFF6</td>
    <td class="tg-c3ow">예약된 클러스터</td>
  </tr>
  <tr>
    <td class="tg-c3ow">0x?FFF FFF7</td>
    <td class="tg-c3ow">손상된 클러스터 Bad Cluster</td>
  </tr>
  <tr>
    <td class="tg-c3ow">0x?FFF FFF8~0x?FFF FFFFF</td>
    <td class="tg-c3ow">마지막 클러스터 표시 End of Makrer</td>
  </tr>
</tbody>
</table>

![ ](/assets/forensic/fatarea.png "Fat Area")

노란색은 조각나 있다.<br>
클러스터가 할당되면 그 엔트리에는 다음 클러스터 주소가 포함된다.<br>
이 의미는 노란색을 보면 쉽게 알 수 있다.<br> 
9번째에 위치한 0x0A(10) 10번을 가리킴 -> 10번째에 0x14(20) -> 20번째에 0x15(21) -> 21번째에 0x16(22) -> 22번째에 0x19(25) -> 25번째 0x1A(26) -> 26번째에 마지막 클러스터 

본 환경에서는<BR>
Reserved Sector Count 예약된 영역의 섹터 크기 0x90 0D (3472)<BR>
섹터 0 ~ 3471 예약된 영역이고<BR>
섹터 3472부터 FAT 영역<BR>

![ ](/assets/forensic/fatarea2.png "Fat Area")

엔트리 0번 - Media Type - F8 FF FF 0F(하드디스크)<br>
엔트리 1번 - Partition Satus FF FF FF FF <br>
엔트리 2번부터 첫 번째 클러스터 (루트 디렉터리)<br>

루트 디렉터리는 BPB에 정의되어 있다.<br>
44~47 Bytes Root Directory Cluster 루트 디렉터리가 있는 클러스터 위치로 FAT32는 FAT12/16과 다르게 가변적, 따라서 위치값을 보고 찾아갈 수 있지만, 일반적으로 클러스터 2번 사용<br> 
0x02 00 00 00 (2)